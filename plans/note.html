<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام بناء المذكرات التعاوني</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>نظام بناء المذكرات التعاوني</h1>
            <p>شارك في بناء مذكرات دروس شاملة مع زملائك الأساتذة</p>
            <button class="btn" onclick="showCreateModal()">+ إنشاء مذكرة جديدة</button>
        </div>
    
    <!-- Filter Section -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
        <label for="areaFilter" style="display: block; font-weight: 600; margin-bottom: 10px; color: #1e293b;">تصفية حسب المجال التعليمي:</label>
        <select id="areaFilter" onchange="filterByArea()" style="width: 100%; max-width: 400px; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 1em;">
            <option value="">جميع المجالات</option>
            <option value="بيئة التعامل مع الحاسوب">بيئة التعامل مع الحاسوب</option>
            <option value="المخططات الانسيابية والخوارزميات">المخططات الانسيابية والخوارزميات</option>
            <option value="تقنيات الويب">تقنيات الويب</option>
            <option value="المكتبية">المكتبية</option>
        </select>
    </div>
    
        <div id="loading" class="loading">جاري التحميل...</div>
        <div id="plansContainer" class="plans-grid" style="display: none;"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <h2>لا توجد مذكرات بعد</h2>
            <p>ابدأ بإنشاء مذكرتك الأولى!</p>
        </div>
    </div>

    <!-- Create/Edit Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeCreateModal()">×</button>
        <h2 style="margin-bottom: 30px; color: #333;">إنشاء مذكرة درس جديدة</h2>

        <div class="form-grid">
            <div class="form-group">
                <label>المجال التعلمي</label>
                <select id="area" onchange="updateUnits()" required>
                    <option value="">اختر المجال</option>
                    <option value="بيئة التعامل مع الحاسوب">بيئة التعامل مع الحاسوب</option>
                    <option value="المخططات الانسيابية والخوارزميات">المخططات الانسيابية والخوارزميات</option>
                    <option value="تقنيات الويب">تقنيات الويب</option>
                    <option value="المكتبية">المكتبية</option>
                </select>
            </div>

            <div class="form-group">
                <label>الوحدة التعلمية</label>
                <select id="unit" onchange="autoFillCurriculumData()" required>
                    <option value="">اختر المجال أولاً</option>
                </select>
            </div>

            <div class="form-group">
                <label>الشعبة</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="classType" value="ج م ع ت" checked>
                        ج م ع ت
                    </label>
                    <label>
                        <input type="radio" name="classType" value="ج م أ">
                        ج م أ
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>نوع المذكرة</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="planType" value="تطبيقية" checked>
                        تطبيقية
                    </label>
                    <label>
                        <input type="radio" name="planType" value="نظرية">
                        نظرية
                    </label>
                </div>
            </div>
        </div>

        <!-- AI GENERATION SECTION 
        <div class="ai-generation-section">
            <p style="color: white; margin-bottom: 15px; font-size: 1.1em;">
                 استخدم الذكاء الاصطناعي لإنشاء خطة الدرس تلقائياً بناءً على المنهاج
            </p>
            <button 
                id="generateWithAI" 
                class="btn" 
                onclick="generateLessonPlanWithAI()" 
                style="background: #8b5cf6; border: none; padding: 12px 30px; font-size: 1.1em; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);"
                disabled>
                 إنشاء بواسطة AI
            </button>
            <p style="color: rgba(255, 255, 255, 0.8); margin-top: 10px; font-size: 0.9em;">
                ⚠️ يمكن استخدام هذه الميزة مرة واحدة فقط لكل مذكرة
            </p>
        </div>
-->
        <div class="form-group">
            <label>عنوان ورقم المذكرة</label>
            <input type="text" id="lessonName" placeholder="أدخل عنوان المذكرة" required>
        </div>

        <!-- الحقول الجديدة -->
        <div class="form-grid">
            <div class="form-group">
                <label>الوسائل المستخدمة</label>
                <textarea id="usedResources" placeholder="أدخل الوسائل المستخدمة في الدرس"></textarea>
            </div>

            <div class="form-group">
                <label>المدة</label>
                <input type="text" id="lessonDuration" placeholder="مثال: 1 ساعة">
            </div>

            <div class="form-group">
                <label>الاستراتيجيات المستعملة</label>
                <textarea id="usedStrategies" placeholder="أدخل الاستراتيجيات المستعملة"></textarea>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>الأهداف التعلمية</label>
                <textarea id="objectives" placeholder="أدخل الأهداف التعلمية" style="transition: background-color 0.3s ease;"></textarea>
            </div>

            <div class="form-group">
                <label>الكفاءة المستهدفة</label>
                <textarea id="competency" placeholder="أدخل الكفاءة المستهدفة" style="transition: background-color 0.3s ease;"></textarea>
            </div>
        </div>

        <div class="table-actions">
            <h3>السير المنهجي للدرس</h3>
            <button class="btn btn-secondary" onclick="addTableRow()">+ إضافة صف</button>
        </div>

        <div style="overflow-x: auto;">
            <table id="lessonTable">
                <thead>
                    <tr>
                        <th rowspan="2">الوضعيات التعليمية</th>
                        <th colspan="3">السير المنهجي للدرس</th>
                        <th rowspan="2">مستوى بلوم/<br>المهارة المستهدفة</th>
                        <th rowspan="2">التقويم المرحلي</th>
                        <th rowspan="2">المدة<br>(دقيقة)</th>
                        <th rowspan="2">حذف</th>
                    </tr>
                    <tr>
                        <th>الموارد</th>
                        <th>دور المعلم</th>
                        <th>دور المتعلم</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td><input type="text" value="وضعية الانطلاق" data-field="situation"></td>
                        <td><textarea data-field="resources"></textarea></td>
                        <td><textarea data-field="teacherRole"></textarea></td>
                        <td><textarea data-field="studentRole"></textarea></td>
                        <td><input type="text" data-field="bloomLevel"></td>
                        <td><textarea data-field="evaluation"></textarea></td>
                        <td><input type="text" data-field="duration" placeholder="مثال: 10"></td>
                        <td style="text-align: center;">
                            <button class="btn-danger" onclick="removeTableRow(this)" disabled>✕</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn" onclick="saveCoursePlan()" style="flex: 1;">حفظ المذكرة</button>
            <button class="btn" onclick="closeCreateModal()" style="flex: 1; background: #6b7280;">إلغاء</button>
        </div>
    </div>
</div>
    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeDetailModal()">×</button>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- Print Info Modal -->
<div id="printInfoModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="close-btn" onclick="closePrintInfoModal()">×</button>
        <h2 style="margin-bottom: 30px; color: #333;">معلومات الطباعة</h2>
        
        <div class="form-group">
            <label>اسم الأستاذ</label>
            <input type="text" id="teacherName" list="teacherList" placeholder="أدخل اسم الأستاذ" required>
            <datalist id="teacherList"></datalist>
        </div>
        
        <div class="form-group">
            <label>اسم الثانوية</label>
            <input type="text" id="schoolName" list="schoolList" placeholder="أدخل اسم الثانوية" required>
            <datalist id="schoolList"></datalist>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn" onclick="confirmPrint()" style="flex: 1;">طباعة</button>
            <button class="btn" onclick="closePrintInfoModal()" style="flex: 1; background: #6b7280;">إلغاء</button>
        </div>
    </div>
</div>
<script>
// =======================
// OPEN PRINT MODAL
// =======================
function openPrintInfoModal() {
    const modal = document.getElementById('printInfoModal');
    const teacherNameInput = document.getElementById('teacherName');
    const schoolNameInput = document.getElementById('schoolName');

    // Keep existing values – only fill if EMPTY
    if (!teacherNameInput.value.trim()) {
        teacherNameInput.value = localStorage.getItem('lastTeacherName') || "";
    }
    if (!schoolNameInput.value.trim()) {
        schoolNameInput.value = localStorage.getItem('lastSchoolName') || "";
    }

    modal.style.display = 'block';
}

// =======================
// CLOSE PRINT MODAL
// =======================
function closePrintInfoModal() {
    document.getElementById('printInfoModal').style.display = 'none';
}

// =======================
// CONFIRM PRINT
// =======================
function confirmPrint() {
    let teacherNameInput = document.getElementById('teacherName');
    let schoolNameInput = document.getElementById('schoolName');

    // Auto-fill if empty
    if (!teacherNameInput.value.trim()) {
        teacherNameInput.value = localStorage.getItem('lastTeacherName') || "";
    }
    if (!schoolNameInput.value.trim()) {
        schoolNameInput.value = localStorage.getItem('lastSchoolName') || "";
    }

    const teacherName = teacherNameInput.value.trim();
    const schoolName = schoolNameInput.value.trim();

    if (!teacherName || !schoolName) {
        alert('الرجاء إدخال جميع البيانات المطلوبة');
        return;
    }

    // Save last used
    localStorage.setItem('lastTeacherName', teacherName);
    localStorage.setItem('lastSchoolName', schoolName);

    // Save history lists
    let teacherHistory = JSON.parse(localStorage.getItem("teacherHistory") || "[]");
    let schoolHistory = JSON.parse(localStorage.getItem("schoolHistory") || "[]");

    if (!teacherHistory.includes(teacherName)) teacherHistory.push(teacherName);
    if (!schoolHistory.includes(schoolName)) schoolHistory.push(schoolName);

    localStorage.setItem("teacherHistory", JSON.stringify(teacherHistory));
    localStorage.setItem("schoolHistory", JSON.stringify(schoolHistory));

    // You already have this
    if (!currentPlanForPrint) {
        alert('حدث خطأ في تحميل بيانات المذكرة');
        return;
    }

    printPlan(currentPlanForPrint, teacherName, schoolName);
    closePrintInfoModal();
}

// =======================
// LOAD HISTORY + LAST VALUES ON PAGE LOAD
// =======================
document.addEventListener('DOMContentLoaded', function () {
    const teacherHistory = JSON.parse(localStorage.getItem("teacherHistory") || "[]");
    const schoolHistory = JSON.parse(localStorage.getItem("schoolHistory") || "[]");

    const teacherList = document.getElementById('teacherList');
    const schoolList = document.getElementById('schoolList');

    // Fill datalist options
    teacherHistory.forEach(name => {
        teacherList.innerHTML += `<option value="${name}"></option>`;
    });

    schoolHistory.forEach(name => {
        schoolList.innerHTML += `<option value="${name}"></option>`;
    });

    const teacherNameInput = document.getElementById('teacherName');
    const schoolNameInput = document.getElementById('schoolName');

    // Fill last used names (only if empty)
    if (!teacherNameInput.value)
        teacherNameInput.value = localStorage.getItem('lastTeacherName') || "";

    if (!schoolNameInput.value)
        schoolNameInput.value = localStorage.getItem('lastSchoolName') || "";
});
</script>

<script src="config.js"></script>
<script src="curriculum-data.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="script.js"></script>
<script src="printUtils.js"></script>
<script src="textEditorModal.js"></script>
<script src="curriculum-images.js"></script> 
<div id="loadingOverlay">
  <div class="loader-box">
    <div class="spinner"></div>
    <p>⏳ جاري إنشاء خطة الدرس بواسطة الذكاء الاصطناعي...</p>
  </div>
</div>
<div id="toastContainer"></div>
</body>
</html>